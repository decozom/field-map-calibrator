<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Field Calibrator</title>

<style>
  body {
    margin: 0;
    background: #111;
    color: #eee;
    text-align: center;
    font-family: "JetBrains Mono", "Source Code Pro", monospace;
  }

  .wrap { padding: 12px 10px 18px; }
  .title { font-size: 18px; margin: 8px 0 4px; }
  .sub {
    font-size: 12px;
    color: #aaa;
    margin: 0 0 10px;
    line-height: 1.4;
  }

  /* ====== 作業用グリッド（距離無関係：見やすさ優先） ====== */
  :root{
    --gridStep: 28px;
    --mapW: min(92vw, 380px);
    --mapH: min(56vh, 480px);

    --imgScale: 1.00; /* JSで変更される（+/-） */
  }

  /* ====== マップエリア ====== */
  #mapArea {
    width: var(--mapW);
    height: var(--mapH);
    margin: 10px auto 10px;
    position: relative;
    border: 2px solid #555;
    background: #222;
    overflow: hidden;
    touch-action: none; /* ピン操作中にスクロールしない */
  }

  #grid {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(to right, #2d2d2d 1px, transparent 1px),
      linear-gradient(to bottom, #2d2d2d 1px, transparent 1px);
    background-size: var(--gridStep) var(--gridStep);
    pointer-events: none;
  }

  /* ====== 地図画像（中央配置＋倍率で拡大縮小） ====== */
  #mapImg {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(var(--imgScale));
    transform-origin: center center;

    max-width: none;
    max-height: none;
    width: auto;
    height: auto;

    opacity: 0.88;
    user-select: none;
    -webkit-user-drag: none;
    pointer-events: none;
  }

  #noImg {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    color: #888;
    font-size: 12px;
    pointer-events: none;
  }

  /* ====== ピン ====== */
  .pin {
    position: absolute;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    border: 2px solid rgba(255,255,255,0.8);
    box-shadow: 0 0 0 2px rgba(0,0,0,0.35);
    touch-action: none;
  }

  .pinLabel {
    position: absolute;
    top: -18px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: #fff;
    text-shadow: 0 1px 2px #000;
    user-select: none;
    pointer-events: none;
    white-space: nowrap;
  }

  .p0 { background: #ff5a5a; }
  .p1 { background: #ffd24a; }
  .p2 { background: #55d8ff; }
  .p3 { background: #7dff7a; }

  /* ====== 情報パネル ====== */
  #panel {
    width: min(92vw, 460px);
    margin: 0 auto;
    text-align: left;
    background: #161616;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 10px 12px;
    line-height: 1.5;
    font-size: 12px;
  }

  #panel .row {
    display: flex;
    gap: 10px;
    justify-content: space-between;
    align-items: baseline;
    border-bottom: 1px dashed #2a2a2a;
    padding: 6px 0;
  }
  #panel .row:last-child { border-bottom: none; }

  .k { color: #bbb; min-width: 46px; }
  .v { color: #cfe8ff; font-variant-numeric: tabular-nums; white-space: nowrap; }

  .hint { color: #aaa; margin-top: 8px; font-size: 12px; }

  /* ====== コントロール ====== */
  .controls {
    width: min(92vw, 460px);
    margin: 8px auto 10px;
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
  }

  button {
    font-size: 14px;
    padding: 8px 12px;
    margin: 0;
  }

  .badge {
    font-size: 12px;
    color: #ddd;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 999px;
    padding: 6px 10px;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="title">Field Calibrator</div>
  <div class="sub">
    ピン(P0〜P3)を地図上の同じ地点に合わせる → 下のXYをメモ。<br>
    画像は「− / ＋」で拡大縮小。scaleと表示サイズ(px)を表示＆コピーできます。
  </div>

  <div id="mapArea">
    <div id="grid"></div>
    <img id="mapImg" alt="map">
    <div id="noImg">画像が未設定です（仮背景で動作中）</div>

    <div class="pin p0" data-id="0"><div class="pinLabel">P0</div></div>
    <div class="pin p1" data-id="1"><div class="pinLabel">P1</div></div>
    <div class="pin p2" data-id="2"><div class="pinLabel">P2</div></div>
    <div class="pin p3" data-id="3"><div class="pinLabel">P3</div></div>
  </div>

  <!-- 画像サイズ調整UI -->
  <div class="controls">
    <button type="button" id="imgMinus">画像 −</button>
    <button type="button" id="imgPlus">画像 ＋</button>
    <button type="button" id="imgReset">画像リセット</button>
    <span class="badge" id="imgInfo">scale:1.00 / size:----×----</span>
    <button type="button" id="copyImgInfo">画像情報コピー</button>
  </div>

  <div id="panel"></div>

  <div class="controls">
    <button type="button" id="resetPinsBtn">ピンを中央に戻す</button>
    <button type="button" id="copyPinsBtn">ピンXYをコピー</button>
  </div>

  <div class="hint">
    ※ピンXYは「mapArea左上を(0,0)」としたピクセル座標。<br>
    ※P0〜P3は「左上→右上→右下→左下」に揃えると事故らない。
  </div>
</div>

<script>
/* =========================================================
  地図画像（あなたの画像ファイル名をセット済み）
========================================================= */
const MAP_IMAGE_URL = "B587C687-7002-42DA-A4F2-A7C82E111540.jpeg";

/* =========================================================
  lat/lonは“直書き”運用（ここは今は未設定でOK）
========================================================= */
const anchorLatLon = [
  { lat: null, lon: null }, // P0
  { lat: null, lon: null }, // P1
  { lat: null, lon: null }, // P2
  { lat: null, lon: null }, // P3
];

/* =========================================================
  画像スケール（+/-で変更）
========================================================= */
const DEFAULT_IMG_SCALE = 1.00;   // 初期倍率（あとで固定したいならここを変える）
let imgScale = DEFAULT_IMG_SCALE;

const SCALE_STEP = 0.05;          // 1回の増減幅
const SCALE_MIN  = 0.30;
const SCALE_MAX  = 3.00;

/* =========================================================
  ピンXY（px）
========================================================= */
const pinXY = [
  { x: 0, y: 0 }, // P0
  { x: 0, y: 0 }, // P1
  { x: 0, y: 0 }, // P2
  { x: 0, y: 0 }, // P3
];

const mapArea = document.getElementById("mapArea");
const mapImg  = document.getElementById("mapImg");
const noImg   = document.getElementById("noImg");
const panel   = document.getElementById("panel");
const pins    = [...document.querySelectorAll(".pin")];
const imgInfo = document.getElementById("imgInfo");

function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

/* ===== 画像読み込み＆表示 ===== */
function setMapImage() {
  if (MAP_IMAGE_URL && MAP_IMAGE_URL.trim().length > 0) {
    mapImg.src = MAP_IMAGE_URL;
    mapImg.style.display = "block";
    noImg.style.display = "none";
  } else {
    mapImg.style.display = "none";
    noImg.style.display = "grid";
  }
}

/* ===== スケール適用（CSS変数に反映） ===== */
function applyScale() {
  document.documentElement.style.setProperty("--imgScale", imgScale.toFixed(2));
  updateImgInfoSoon(); // 描画反映後に情報更新
}

/* ===== 画像サイズ表示（実際に画面に表示されてるpxを出す） ===== */
let infoTimer = null;
function updateImgInfoSoon(){
  if (infoTimer) clearTimeout(infoTimer);
  infoTimer = setTimeout(updateImgInfo, 60);
}

function updateImgInfo(){
  // 画像がまだ読めてない場合
  if (!mapImg.complete || mapImg.naturalWidth === 0) {
    imgInfo.textContent = `scale:${imgScale.toFixed(2)} / size:----×----`;
    return;
  }

  // transform(=scale)込みの「画面上の実サイズ」は getBoundingClientRect が確実
  const r = mapImg.getBoundingClientRect();
  const w = Math.round(r.width);
  const h = Math.round(r.height);

  // 元画像サイズも欲しければここで取れる
  // const nw = mapImg.naturalWidth;
  // const nh = mapImg.naturalHeight;

  imgInfo.textContent = `scale:${imgScale.toFixed(2)} / size:${w}×${h}px`;
}

/* ===== ピン初期配置 ===== */
function centerPins() {
  const r = mapArea.getBoundingClientRect();
  const cx = r.width / 2;
  const cy = r.height / 2;

  const offsets = [
    {dx: -60, dy: -60}, // P0
    {dx:  60, dy: -60}, // P1
    {dx:  60, dy:  60}, // P2
    {dx: -60, dy:  60}, // P3
  ];

  offsets.forEach((o, i) => {
    pinXY[i].x = clamp(cx + o.dx, 0, r.width);
    pinXY[i].y = clamp(cy + o.dy, 0, r.height);
  });

  renderPins();
}

function renderPins() {
  pins.forEach(pin => {
    const id = Number(pin.dataset.id);
    pin.style.left = `${pinXY[id].x}px`;
    pin.style.top  = `${pinXY[id].y}px`;
  });
  renderPanel();
}

function renderPanel() {
  const lines = [];

  for (let i = 0; i < 4; i++) {
    const xy = pinXY[i];
    const ll = anchorLatLon[i];
    const llText =
      (ll.lat == null || ll.lon == null)
        ? "lat/lon: (未設定)"
        : `lat:${ll.lat}, lon:${ll.lon}`;

    lines.push(`
      <div class="row">
        <div class="k">P${i}</div>
        <div class="v">x:${xy.x.toFixed(1)}  y:${xy.y.toFixed(1)}</div>
        <div class="k">${llText}</div>
      </div>
    `);
  }

  panel.innerHTML = lines.join("");
}

/* ===== ピンのドラッグ（iPhone対応：pointer events） ===== */
let draggingId = null;

function pointerToLocalXY(e) {
  const r = mapArea.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;
  return { x: clamp(x, 0, r.width), y: clamp(y, 0, r.height) };
}

pins.forEach(pin => {
  pin.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    pin.setPointerCapture(e.pointerId);
    draggingId = Number(pin.dataset.id);
  });

  pin.addEventListener("pointermove", (e) => {
    if (draggingId === null) return;
    const {x, y} = pointerToLocalXY(e);
    pinXY[draggingId].x = x;
    pinXY[draggingId].y = y;
    renderPins();
  });

  pin.addEventListener("pointerup", (e) => {
    draggingId = null;
    try { pin.releasePointerCapture(e.pointerId); } catch {}
  });

  pin.addEventListener("pointercancel", () => {
    draggingId = null;
  });
});

/* ===== コピーユーティリティ ===== */
async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    alert("コピーした:\n\n" + text);
  } catch {
    prompt("コピーして:", text);
  }
}

/* ===== ボタン：画像拡大縮小 ===== */
document.getElementById("imgMinus").addEventListener("click", () => {
  imgScale = clamp(imgScale - SCALE_STEP, SCALE_MIN, SCALE_MAX);
  applyScale();
});

document.getElementById("imgPlus").addEventListener("click", () => {
  imgScale = clamp(imgScale + SCALE_STEP, SCALE_MIN, SCALE_MAX);
  applyScale();
});

document.getElementById("imgReset").addEventListener("click", () => {
  imgScale = DEFAULT_IMG_SCALE;
  applyScale();
});

/* 画像情報コピー（scaleとサイズをそのまま貼れる形に） */
document.getElementById("copyImgInfo").addEventListener("click", () => {
  const text = imgInfo.textContent
    + `\nMAP_IMAGE_URL="${MAP_IMAGE_URL}"\nDEFAULT_IMG_SCALE=${imgScale.toFixed(2)}`;
  copyText(text);
});

/* ===== ボタン：ピン操作 ===== */
document.getElementById("resetPinsBtn").addEventListener("click", centerPins);

document.getElementById("copyPinsBtn").addEventListener("click", () => {
  const text = pinXY.map((p, i) => `P${i}: x=${p.x.toFixed(1)}, y=${p.y.toFixed(1)}`).join("\n");
  copyText(text);
});

/* ===== 初期化 ===== */
setMapImage();
applyScale();
centerPins();

/* 画像読み込み完了時にサイズ表示を更新 */
mapImg.addEventListener("load", () => {
  updateImgInfoSoon();
});

/* 画面回転などでmapAreaサイズが変わったら、表示情報更新 */
window.addEventListener("resize", () => {
  updateImgInfoSoon();
  // ピンの位置もズレるので、ここは安全に中央へ戻す（事故防止）
  centerPins();
});
</script>
</body>
</html>